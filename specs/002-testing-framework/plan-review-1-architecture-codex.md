# Architecture Review (helicopter view)

1. Terraform/OpenTofu state strategy is inconsistent and currently unworkable for shared, persistent test VMs. `plan.md` and `research.md` assume local state (ephemeral in CI runners), while `pre-analysis/testing-implementation-plan.md` documents an S3 backend. With local state, CI cannot safely reuse or tear down the long-lived Hetzner VMs, and developers would drift from CI with competing state files. A single authoritative remote backend and ownership model is needed to avoid duplicate VMs, orphaned resources, and accidental destroys (reliability without compromise, deliberate simplicity).
2. Scope overshoots the feature and the constitutionâ€™s YAGNI/Deliberate Simplicity guardrails. The pre-analysis plan enumerates 40+ concrete unit/integration tests for the 001-foundation feature plus a full CI workflow and playbook work (`pre-analysis/testing-implementation-plan.md`), even though this feature is only about the testing framework. That coupling makes the plan hard to execute incrementally and obscures what belongs to this feature versus future feature-specific test authoring. The plan should focus on framework architecture (VM provisioning/reset, locking, CI hooks, fixtures, docs) and leave test backlogs to the features they validate.
3. Provisioning/reset flow is described in conflicting ways, leaving no single authoritative lifecycle. Snapshot naming, reset mechanics, and host configuration differ between `research.md` (baseline-@ / active-@ set-default flow), `quickstart.md` (manual tofu apply + scripts), and `pre-analysis/testing-implementation-plan.md` (baseline-root/home with S3 backend). It is unclear which reset script and snapshot layout the framework standardizes, or how automatic provisioning is actually triggered vs. manual setup. This ambiguity threatens reliability (resets might not line up with created snapshots) and complicates future changes to the infra scripts.
4. Concurrency control is specified but not wired through all destructive operations. The lock model in `research.md`/`data-model.md` lives on pc1 `/tmp`, yet the documented flows for provisioning (`quickstart.md`) and VM resets do not mandate acquiring the lock before mutating shared VMs/terraform state. CI concurrency groups avoid overlapping CI jobs, but they do not protect against a developer run happening concurrently. The architecture needs a single enforced gate (lock acquisition) around provisioning, reset, and integration test execution so dev/CI cannot race and leave VMs in an inconsistent state.
