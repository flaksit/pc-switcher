# Plan Review (Detail)

1. Provisioning tooling is inconsistent: `data-model.md` models VM lifecycle with "tofu apply/destroy" and `plan.md` lists OpenTofu as a chosen tool, but `research.md` and the spec expect hcloud CLI only (no OpenTofu). This contradiction could push implementation toward the wrong toolchain and commands. Please align all docs on the hcloud-only approach.
2. Integration test provisioning is not truly automatic. `quickstart.md` requires developers to run `provision-vms.sh` manually before `uv run pytest -m integration`, but spec FR-006 says integration tests auto-provision VMs (including OS + btrfs) when absent. The plan needs a flow that provisions on-demand for local runs as well, not just CI.
3. FR-003a contract coverage is missing. There is no plan item to add contract tests that verify MockExecutor vs LocalExecutor/RemoteExecutor parity. Without this, the required mock/real interface validation will be skipped.
4. Lock contract diverges from the spec. `pre-analysis/testing-implementation-plan.md` defines `lock.sh` writing only a holder string inside a directory, while `data-model.md` and FR-005 require a JSON lock file with holder + acquisition time (+ hostname) at `/tmp/pc-switcher-integration-test.lock`. The missing timestamp/hostname and differing format/path will break the promised holder identity tracking.
5. Env var skip logic is incomplete. The proposed `pytest_collection_modifyitems` in `research.md` only checks `PC_SWITCHER_TEST_PC1_HOST`; if `PC_SWITCHER_TEST_PC2_HOST` or `PC_SWITCHER_TEST_USER` are missing, tests would run and fail instead of skipping with a clear message (FR-008b).
6. Reset flow lacks actionable failure for missing baselines. The reset procedure in `pre-analysis/testing-implementation-plan.md` assumes baseline snapshots exist and will error out mid-run without the spec-mandated clear message when `/.snapshots/baseline/@` or `@home` are missing/invalid (FR-004).
7. CI key injection for auto-provisioning is unclear. FR-006a requires injecting CI-provided SSH keys into the test user during auto-provisioning. The CI workflow sets a private key for SSH but never passes a public key to `provision-vms.sh`/`provision.sh`, which default to `~/.ssh/id_ed25519.pub` (likely absent in CI). This risks provisioning VMs without CI access or failing creation.
8. Fork/missing-secret handling is absent. `.github/workflows/test.yml` runs integration tests on PRs to `main` with required secrets, but GitHub does not expose secrets to forks. There is no guard to skip with a clear notice when secrets are unavailable, violating FR-017a/FR-017b and causing guaranteed failures on forked PRs.
9. CI artifact retention is missing. FR-017c requires preserving pytest output and provisioning/reset logs. The planned workflow has no artifact uploads, so failures would lack the mandated debugging evidence.
10. Manual playbook deliverable is off-path and incomplete. The plan proposes `tests/playbook/visual-verification.md`, but FR-033 mandates `docs/testing-playbook.md` covering both visual verification and the guided feature tour (FR-018–FR-020). The current plan risks placing the playbook in the wrong location and omitting the guided-tour scope.
11. Ops/Dev guide content requirements are not called out. FR-021–FR-029 specify concrete sections (fixtures/how-to-write tests, SSH/btrfs patterns, troubleshooting, secrets/env vars with defaults, cost monitoring, and infrastructure failure runbooks). The plan lists the file names but does not ensure these sections will be included, so key required content may be missed.
