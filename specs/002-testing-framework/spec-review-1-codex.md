# Specification Review – Testing Framework

- **Auto-provisioning vs current design**: User Story 2 + FR-006 promise automatic VM provisioning on first integration test run, but `docs/testing-framework.md` and the pre-analysis plan require manual OpenTofu provisioning + rescue-mode installimage before resets work. Clarify whether provisioning is automated (and how credentials/backend are supplied) or explicitly document the manual prerequisite so the acceptance scenarios are achievable.
- **Baseline reset prerequisites**: FR-004/017 assume VMs can be reset before every session, but there’s no requirement that baseline snapshots exist or that resets fail-fast when baselines are missing or stale. Add an explicit requirement to create/validate baseline snapshots at provisioning time and to surface actionable errors if reset prerequisites are absent.
- **Lock robustness**: FR-005 and Edge Cases mention lock timeout/failure to acquire, but there is no requirement for stale lock detection/cleanup, who is allowed to break a lock, or guaranteed release on test crashes. Define TTL/heartbeat/owner metadata and a recovery path so the lock cannot wedge integration runs indefinitely.
- **Realistic reset SLO**: SC-001 requires <30s reset for all VMs; with snapshot deletion/creation and a full reboot on cloud VMs, 30s may be optimistic. Specify the measurement point (start/end), expected variance, and a fallback (e.g., alert if >60s) to keep this testable and non-flaky.
- **Safe default test commands**: FR-007/008 require a single unit-test command and a marker for integrations, but the spec doesn’t state whether `uv run pytest` or CI’s default target excludes `-m integration` when env/secrets are missing. Add a requirement that integration tests are skipped with a clear message when VM env vars are absent, and that the default test entry points cannot accidentally trigger VM usage on developer machines.
- **CI scope and secrets**: FR-013–015 don’t cover forked PRs or missing secrets. Define expected behavior (skip integration with clear notice vs hard fail) when secrets are unavailable, and state whether integration on forks is supported. Also clarify whether CI should tolerate absent tfstate/object-storage creds or fail early with guidance.
- **Documentation placement & format**: FR-018–033 list deliverables but don’t specify where the manual playbook lives or how it relates to the existing `specs/001-foundation/testing-playbook.md`. Clarify whether the playbook is updated in-place or relocated. Also add that architecture diagrams MUST be in Mermaid (per repo docs standard) to avoid format ambiguity.
- **Cost requirement enforcement**: FR-012/SC-005 cap monthly spend at €10, but there’s no measurement or alerting requirement, and two CX23 VMs plus object storage may already be close to the cap. Add a requirement for cost tracking (e.g., monthly report/alert) and document what happens if the cap is exceeded (shutdown policy, scale-down plan).
- **Provider specificity**: Assumptions mention a cloud provider but not which one; the rest of the docs assume Hetzner Cloud + object storage. Make the provider explicit here to avoid divergence with provisioning scripts and CI workflows.
