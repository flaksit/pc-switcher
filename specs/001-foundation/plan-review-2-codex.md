# Plan Review 2 (verification against spec.md & architecture.md)

- **Version check ordering conflicts spec**: `architecture.md` execution flow runs pre-sync snapshots before `InstallOnTargetJob`. `spec.md` User Story 2 and FR-005 require the version check/install to be the very first operation (before validation or snapshots), and User Story 3 requires snapshots only after version check + subvolume checks. Please realign the ordering and spell out when installation happens vs. snapshot creation.
- **Self-installation flow under-specified**: Beyond the box in `architecture.md`, there is no plan for detecting target version, handling missing install, upgrade/downgrade paths, or the abort-on-newer-target rule (FR-005/FR-006/SC-004). Add a concrete flow and commands (e.g., `uv tool install git+https://...@v<version>`) plus success verification and timing.
- **Disk space preflight missing**: Runtime monitoring via `DiskSpaceMonitorJob` is covered, but there is no pre-sync free-space check (FR-016, acceptance scenario 8). Document when/how preflight thresholds are evaluated on both hosts and how failures halt the run.
- **Snapshot cleanup design absent**: CLI mentions `cleanup-snapshots`, and config has retention fields, but no workflow exists for applying `keep_recent`/`max_age_days` or guaranteeing the “keep most recent 3 sessions” rule (FR-014, User Story 3 scenario 7). Add the algorithm and where it runs.
- **Install/setup script not planned**: FR-035–FR-037 call for a setup script that enforces btrfs, installs deps (uv, btrfs-progs, etc.), and generates a commented default config. No artifact describes this; `quickstart.md` is developer-focused and even suggests `uv pip install -e .`, which conflicts with the repo’s uv-only conventions. Add the setup flow and fix the command guidance.
- **Dummy job example diverges from spec**: In `quickstart.md` the `DummySuccessJob` sample logs every 1s, warns/errors at ~4s/5s, and progress never reaches 100%. Spec requires 20s per side with 2s logging cadence, WARNING at 6s, ERROR at 8s, and progress at 0/25/50/75/100 (FR-039, User Story 8). Adjust the reference example to avoid misimplementation.
- **Job interface gap**: `contracts/job-interface.md` omits the `get_config_schema` accessor promised in FR-001 (only `CONFIG_SCHEMA` is provided). Clarify the required API so orchestrator/job authors have a single canonical hook.
- **Logging serialization inconsistency**: `quickstart.md`’s `FileLogger` uses `event.to_json()`, but `data-model.md`’s `LogEvent` has no such method. Define the serialization strategy (structlog JSONRenderer per FR-022) so producers/consumers match.
- **Locking not integrated**: FR-047 requires source/target lock enforcement. `research.md` covers flock mechanics, but `architecture.md` lacks any mention of lock acquisition in the sync flow or connection setup. Add where locks are taken/released (both hosts) to prevent concurrent runs.
