# PC-switcher Configuration Schema (JSON Schema draft-07)
# This schema defines the structure of ~/.config/pc-switcher/config.yaml
#
# Reference: FND-FR-CONFIG-FORMAT, FND-FR-CONFIG-VALIDATE

$schema: "http://json-schema.org/draft-07/schema#"
$id: "https://pc-switcher/config-schema.yaml"
title: "PC-switcher Configuration"
description: "Configuration file schema for pc-switcher sync operations"
type: object

definitions:
  # Reusable threshold pattern for disk space
  disk_threshold:
    type: string
    pattern: "^\\d+(%|GiB|MiB|GB|MB)$"
    description: "Disk space threshold as percentage (e.g., '20%') or absolute (e.g., '50GiB')"

  # Log level enum
  log_level:
    type: string
    enum: ["DEBUG", "FULL", "INFO", "WARNING", "ERROR", "CRITICAL"]
    description: "Log verbosity level. DEBUG is most verbose, CRITICAL is least."

  # Btrfs subvolume name pattern
  subvolume_name:
    type: string
    pattern: "^@"
    description: "Btrfs subvolume name (must start with @)"

properties:
  # Logging configuration (3-setting model)
  logging:
    type: object
    description: "Logging level configuration for the 3-setting model"
    properties:
      file:
        $ref: "#/definitions/log_level"
        default: "DEBUG"
        description: "Minimum log level for file output"
      tui:
        $ref: "#/definitions/log_level"
        default: "INFO"
        description: "Minimum log level for TUI output"
      external:
        $ref: "#/definitions/log_level"
        default: "WARNING"
        description: "Minimum log level for external library logs"
    additionalProperties: false

  # Job enable/disable flags
  # NOTE: Only explicitly listed job names are valid. Unknown job names will cause validation to fail.
  sync_jobs:
    type: object
    description: "Enable or disable optional sync jobs. Unknown job names are rejected."
    properties:
      # Jobs implemented in 001-core:
      dummy_success:
        type: boolean
        default: true
        description: "Test job that completes successfully"
      dummy_fail:
        type: boolean
        default: false
        description: "Test job that fails at configurable time"
      # Future jobs (add when features 5-10 are implemented):
      # user_data:
      #   type: boolean
      #   default: true
      # packages:
      #   type: boolean
      #   default: true
      # docker:
      #   type: boolean
      #   default: false
      # vms:
      #   type: boolean
      #   default: false
      # k3s:
      #   type: boolean
      #   default: false
    additionalProperties: false  # Reject unknown job names (FR edge case)
    default: {}

  # Disk space monitoring (DiskSpaceMonitorJob)
  # NOTE: Config key matches job module name (disk_space_monitor.py -> disk_space_monitor)
  disk_space_monitor:
    type: object
    description: "Disk space monitoring configuration for DiskSpaceMonitorJob"
    properties:
      preflight_minimum:
        $ref: "#/definitions/disk_threshold"
        default: "20%"
        description: "Minimum free space required before sync starts"
      runtime_minimum:
        $ref: "#/definitions/disk_threshold"
        default: "15%"
        description: "Minimum free space required during sync (CRITICAL - abort if below)"
      warning_threshold:
        $ref: "#/definitions/disk_threshold"
        default: "25%"
        description: "Free space threshold for warnings during sync"
      check_interval:
        type: integer
        minimum: 5
        maximum: 300
        default: 30
        description: "Seconds between disk space checks during sync"
    additionalProperties: false

  # Btrfs snapshot configuration
  btrfs_snapshots:
    type: object
    description: "Btrfs snapshot management configuration"
    required:
      - subvolumes
    properties:
      subvolumes:
        type: array
        items:
          $ref: "#/definitions/subvolume_name"
        minItems: 1
        description: "List of btrfs subvolumes to snapshot (must match YOUR system's layout)"
        examples:
          # These are examples - configure based on your actual subvolumes:
          - ["@", "@home"]
      keep_recent:
        type: integer
        minimum: 1
        default: 3
        description: "Number of recent sync sessions to retain snapshots for"
      max_age_days:
        type: integer
        minimum: 1
        description: "Maximum age in days for snapshot retention (optional)"
    additionalProperties: false

  # Dummy job configuration (testing)
  dummy_success:
    type: object
    description: "Configuration for dummy-success test job"
    properties:
      source_duration:
        type: integer
        minimum: 1
        default: 20
        description: "Seconds to run on source machine"
      target_duration:
        type: integer
        minimum: 1
        default: 20
        description: "Seconds to run on target machine"
    additionalProperties: false

  dummy_fail:
    type: object
    description: "Configuration for dummy-fail test job"
    properties:
      source_duration:
        type: integer
        minimum: 2
        default: 10
        description: "Seconds to run on source machine"
      target_duration:
        type: integer
        minimum: 2
        default: 10
        description: "Seconds to run on target machine"
      fail_at:
        type: integer
        minimum: 2
        default: 12
        description: "Elapsed seconds at which to fail"
    additionalProperties: false

# =============================================================================
# DEVELOPER NOTE: Config Key Naming Convention
# =============================================================================
# All job configuration MUST use a top-level key that exactly matches the
# job's module name (the `name` class attribute). This ensures:
#   1. Predictable config location for any job
#   2. Automatic config routing by orchestrator
#   3. Clear correspondence between code and config
#
# Examples:
#   - disk_space_monitor.py (DiskSpaceMonitorJob) -> disk_space_monitor:
#   - btrfs_snapshots.py (BtrfsSnapshotJob) -> btrfs_snapshots:
#   - dummy_success (DummySuccessJob) -> dummy_success:
#   - user_data.py (UserDataJob) -> user_data:
#
# Future job configs will be added here as top-level keys when features are implemented:
# user_data:
#   exclude_patterns: [...]
#   preserve_timestamps: true
# packages:
#   sync_ppa: true
#   sync_flatpak: true
# etc.

additionalProperties: false  # Strict schema for current scope; evolves as features are added
