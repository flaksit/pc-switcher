name: PR metadata

on:
  pull_request:
    types:
      - opened
      - edited
      - synchronize
      - reopened
      - ready_for_review

permissions:
  contents: read
  pull-requests: read

jobs:
  requires-issue-closing-keyword:
    name: Requires issue closing keyword
    runs-on: ubuntu-latest
    if: github.event.pull_request.draft == false

    steps:
      - name: Validate PR references issues
        uses: actions/github-script@v7
        with:
          script: |
            const pr = context.payload.pull_request;
            const prHaystack = `${pr.title}\n\n${pr.body || ""}`;

            // "Fixes #123" style lines are the standard practice.
            // We enforce: if any commit message contains closing keywords, the PR must contain matching ones.
            const closingPattern = /(close[sd]?|fix(e[sd])?|resolve[sd]?)\s+#(?<num>[0-9]+)/gi;

            const prClosingNums = new Set();
            for (const match of prHaystack.matchAll(closingPattern)) {
              prClosingNums.add(match.groups.num);
            }

            const commits = await github.paginate(
              github.rest.pulls.listCommits,
              {
                owner: context.repo.owner,
                repo: context.repo.repo,
                pull_number: pr.number,
                per_page: 100,
              }
            );

            const commitClosingNums = new Set();
            for (const c of commits) {
              const message = c.commit?.message || "";
              for (const match of message.matchAll(closingPattern)) {
                commitClosingNums.add(match.groups.num);
              }
            }

            if (commitClosingNums.size === 0) {
              // No closing keywords in commits; nothing to enforce.
              return;
            }

            const missing = [...commitClosingNums].filter((n) => !prClosingNums.has(n));

            if (missing.length > 0) {
              core.setFailed(
                [
                  "PR commit messages contain issue closing keywords, but the PR description/title does not.",
                  `Missing in PR: ${missing.map((n) => `#${n}`).join(", ")}`,
                  "Add one line per issue to the PR description, e.g.:",
                  "  Fixes #123",
                  "See docs/developer-workflow.md for details."
                ].join("\n")
              );
            }
