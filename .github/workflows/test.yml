name: Test (Integration)

on:
  pull_request:
    branches: [main]
  workflow_dispatch:

jobs:
  integration:
    name: Integration Tests
    runs-on: ubuntu-latest
    concurrency:
      group: pc-switcher-integration
      cancel-in-progress: false
    steps:
      - uses: actions/checkout@v4

      - name: Check fork status and secrets
        run: |
          if [[ "${{ github.event_name }}" == "pull_request" ]] && \
             [[ "${{ github.event.pull_request.head.repo.full_name }}" != "${{ github.repository }}" ]]; then
            echo "::notice::Integration tests skipped: Fork PRs do not have access to secrets"
            exit 0
          fi
          if [[ -z "${{ secrets.HCLOUD_TOKEN }}" ]] || [[ -z "${{ secrets.HETZNER_SSH_PRIVATE_KEY }}" ]]; then
            echo "::error::Integration tests cannot run: Required secrets (HCLOUD_TOKEN, HETZNER_SSH_PRIVATE_KEY) are not available"
            exit 1
          fi

      - name: Install uv
        uses: astral-sh/setup-uv@v6
        with:
          version: "latest"

      - name: Install hcloud CLI
        run: |
          curl -L https://github.com/hetznercloud/cli/releases/latest/download/hcloud-linux-amd64.tar.gz | tar xz
          sudo mv hcloud /usr/local/bin/
          hcloud version

      - name: Setup SSH key
        run: |
          mkdir -p ~/.ssh
          echo "${{ secrets.HETZNER_SSH_PRIVATE_KEY }}" > ~/.ssh/id_ed25519
echo "${{ secrets.SSH_AUTHORIZED_KEY_CI }}" > ~/.ssh/id_ed25519.pub
          chmod 600 ~/.ssh/id_ed25519
          ssh-keyscan -H $(hcloud server ip pc1 || echo "") >> ~/.ssh/known_hosts 2>/dev/null || true
          ssh-keyscan -H $(hcloud server ip pc2 || echo "") >> ~/.ssh/known_hosts 2>/dev/null || true
        env:
          HCLOUD_TOKEN: ${{ secrets.HCLOUD_TOKEN }}

      - name: Provision test infrastructure
        env:
          SECRETS_JSON: ${{ toJSON(secrets) }}
          HCLOUD_TOKEN: ${{ secrets.HCLOUD_TOKEN }}
        run: |
          # Collect all SSH_AUTHORIZED_KEY_* secrets into single variable
          SSH_AUTHORIZED_KEYS=$(echo "$SECRETS_JSON" | jq -r 'to_entries[] | select(.key | startswith("SSH_AUTHORIZED_KEY_")) | .value')
          export SSH_AUTHORIZED_KEYS
          tests/infrastructure/scripts/provision-test-infra.sh 2>&1 | tee provision-output.log
        timeout-minutes: 30

      - name: Get VM IPs
        id: vm_ips
        run: |
          PC1_IP=$(hcloud server ip pc1)
          PC2_IP=$(hcloud server ip pc2)
          echo "pc1_ip=$PC1_IP" >> $GITHUB_OUTPUT
          echo "pc2_ip=$PC2_IP" >> $GITHUB_OUTPUT
        env:
          HCLOUD_TOKEN: ${{ secrets.HCLOUD_TOKEN }}

      - name: Run integration tests
        run: uv run pytest -m integration -v 2>&1 | tee pytest-output.log
        env:
          PC_SWITCHER_TEST_PC1_HOST: ${{ steps.vm_ips.outputs.pc1_ip }}
          PC_SWITCHER_TEST_PC2_HOST: ${{ steps.vm_ips.outputs.pc2_ip }}
          PC_SWITCHER_TEST_USER: testuser
          CI_JOB_ID: ${{ github.run_id }}
        timeout-minutes: 30

      - name: Upload test logs
        if: always()
        uses: actions/upload-artifact@v4
        with:
          name: test-logs
          path: |
            provision-output.log
            pytest-output.log
          retention-days: 14
          if-no-files-found: warn
