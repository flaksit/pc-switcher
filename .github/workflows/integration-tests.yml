name: Integration Tests

on:
  pull_request:
    branches:
      - main
    paths:
      - '.github/workflows/integration-tests.yml'
      - 'src/**'
      - 'tests/integration/**'
      - 'install.sh'
      - 'pyproject.toml'
      - 'uv.lock'
    types:
      - opened
      - synchronize
      - reopened
      - ready_for_review
  workflow_dispatch:

jobs:
  integration:
    name: Integration Tests
    if: github.event.pull_request.draft == false
    runs-on: ubuntu-latest
    concurrency:
      group: pc-switcher-integration
      cancel-in-progress: false
    steps:
      - uses: actions/checkout@v6
        with:
          fetch-depth: 0

      - name: Install uv
        uses: astral-sh/setup-uv@v4

      - name: Check secrets
        run: |
          if [[ -z "${{ secrets.HCLOUD_TOKEN }}" ]] || [[ -z "${{ secrets.HETZNER_SSH_PRIVATE_KEY }}" ]]; then
            echo "::error::Integration tests cannot run: Required secrets (HCLOUD_TOKEN, HETZNER_SSH_PRIVATE_KEY) are not available"
            exit 1
          fi

      - name: Install Hetzner Cloud CLI
        uses: hetznercloud/setup-hcloud@v1

      - name: Setup SSH key and get existing VM IPs
        id: vm_ips
        run: |
          mkdir -p ~/.ssh
          echo "${{ secrets.HETZNER_SSH_PRIVATE_KEY }}" > ~/.ssh/id_ed25519
          echo "${{ secrets.SSH_AUTHORIZED_KEY_CI }}" > ~/.ssh/id_ed25519.pub
          chmod 600 ~/.ssh/id_ed25519
          # Get IPs once (if VMs exist) for known_hosts and later use
          PC1_IP=$(hcloud server ip pc1 2>/dev/null || echo "")
          PC2_IP=$(hcloud server ip pc2 2>/dev/null || echo "")
          if [[ -n "$PC1_IP" ]]; then
            ssh-keyscan -H "$PC1_IP" >> ~/.ssh/known_hosts 2>/dev/null || true
            echo "pc1_ip=$PC1_IP" >> $GITHUB_OUTPUT
          fi
          if [[ -n "$PC2_IP" ]]; then
            ssh-keyscan -H "$PC2_IP" >> ~/.ssh/known_hosts 2>/dev/null || true
            echo "pc2_ip=$PC2_IP" >> $GITHUB_OUTPUT
          fi
        env:
          HCLOUD_TOKEN: ${{ secrets.HCLOUD_TOKEN }}

      - name: Provision test infrastructure
        id: provision
        env:
          SECRETS_JSON: ${{ toJSON(secrets) }}
          HCLOUD_TOKEN: ${{ secrets.HCLOUD_TOKEN }}
        run: |
          set -o pipefail
          # Collect all SSH_AUTHORIZED_KEY_* secrets into single variable
          SSH_AUTHORIZED_KEYS=$(echo "$SECRETS_JSON" | jq -r 'to_entries[] | select(.key | startswith("SSH_AUTHORIZED_KEY_")) | .value')
          export SSH_AUTHORIZED_KEYS
          tests/integration/scripts/provision-test-infra.sh 2>&1 | tee provision-output.log
          # If VMs were just created, get their IPs now
          if [[ -z "${{ steps.vm_ips.outputs.pc1_ip }}" ]]; then
            PC1_IP=$(hcloud server ip pc1)
            echo "pc1_ip=$PC1_IP" >> $GITHUB_OUTPUT
          fi
          if [[ -z "${{ steps.vm_ips.outputs.pc2_ip }}" ]]; then
            PC2_IP=$(hcloud server ip pc2)
            echo "pc2_ip=$PC2_IP" >> $GITHUB_OUTPUT
          fi
        timeout-minutes: 30

      - name: Run integration tests
        run: |
          set -o pipefail
          ./tests/run-integration-tests.sh 2>&1 | tee pytest-output.log
        env:
          HCLOUD_TOKEN: ${{ secrets.HCLOUD_TOKEN }}
          PC_SWITCHER_TEST_PC1_HOST: ${{ steps.vm_ips.outputs.pc1_ip || steps.provision.outputs.pc1_ip }}
          PC_SWITCHER_TEST_PC2_HOST: ${{ steps.vm_ips.outputs.pc2_ip || steps.provision.outputs.pc2_ip }}
          PC_SWITCHER_TEST_USER: testuser
          CI_JOB_ID: ${{ github.run_id }}
          GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}
        timeout-minutes: 30

      - name: Upload test logs
        if: always()
        uses: actions/upload-artifact@v4
        with:
          name: test-logs
          path: |
            provision-output.log
            pytest-output.log
          retention-days: 14
          if-no-files-found: warn
