name: VM Updates

on:
  schedule:
    # Run daily at 2am UTC
    # Daily schedule ensures unattended-upgrades changes are incorporated into
    # baseline snapshots promptly (see issue #109 for rationale)
    - cron: '0 2 * * *'
  workflow_dispatch:

jobs:
  upgrade-vms:
    name: Upgrade Test VMs
    runs-on: ubuntu-latest
    steps:
      - name: Check secrets
        run: |
          if [[ -z "${{ secrets.HCLOUD_TOKEN }}" ]] || [[ -z "${{ secrets.HETZNER_SSH_PRIVATE_KEY }}" ]]; then
            echo "::error::VM maintenance cannot run: Required secrets (HCLOUD_TOKEN, HETZNER_SSH_PRIVATE_KEY) are not available"
            exit 1
          fi

      - name: Install Hetzner Cloud CLI
        uses: hetznercloud/setup-hcloud@v1

      - name: Resolve VM IPs
        id: vm_ips
        env:
          HCLOUD_TOKEN: ${{ secrets.HCLOUD_TOKEN }}
        run: |
          set -euo pipefail
          if ! VM_LIST=$(hcloud server list -o columns=name,ipv4 -o noheader); then
            echo "::error::Failed to list VMs via hcloud"
            exit 1
          fi
          PC1_IP=$(echo "$VM_LIST" | awk '$1 == "pc1" {print $2}')
          PC2_IP=$(echo "$VM_LIST" | awk '$1 == "pc2" {print $2}')
          if [[ -n "$PC1_IP" && -n "$PC2_IP" ]]; then
            echo "vms_exist=true" >> $GITHUB_OUTPUT
          else
            echo "vms_exist=false" >> $GITHUB_OUTPUT
          fi
          if [[ -n "$PC1_IP" ]]; then
            echo "pc1_ip=$PC1_IP" >> $GITHUB_OUTPUT
          fi
          if [[ -n "$PC2_IP" ]]; then
            echo "pc2_ip=$PC2_IP" >> $GITHUB_OUTPUT
          fi

      - name: Setup SSH key
        if: steps.vm_ips.outputs.vms_exist == 'true'
        env:
          HCLOUD_TOKEN: ${{ secrets.HCLOUD_TOKEN }}
        run: |
          set -euo pipefail
          mkdir -p ~/.ssh
          echo "${{ secrets.HETZNER_SSH_PRIVATE_KEY }}" > ~/.ssh/id_ed25519
          echo "${{ secrets.SSH_AUTHORIZED_KEY_CI }}" > ~/.ssh/id_ed25519.pub
          chmod 600 ~/.ssh/id_ed25519
          if [[ -n "${{ steps.vm_ips.outputs.pc1_ip }}" ]]; then
            ssh-keyscan -H "${{ steps.vm_ips.outputs.pc1_ip }}" >> ~/.ssh/known_hosts 2>/dev/null
          fi
          if [[ -n "${{ steps.vm_ips.outputs.pc2_ip }}" ]]; then
            ssh-keyscan -H "${{ steps.vm_ips.outputs.pc2_ip }}" >> ~/.ssh/known_hosts 2>/dev/null
          fi

      - name: Checkout
        if: steps.vm_ips.outputs.vms_exist == 'true'
        uses: actions/checkout@v4

      - name: Upgrade VMs (with retry on lock)
        if: steps.vm_ips.outputs.vms_exist == 'true'
        env:
          HCLOUD_TOKEN: ${{ secrets.HCLOUD_TOKEN }}
        run: |
          # Retry logic: if VMs are locked (e.g., integration tests running),
          # wait and retry. Integration tests take ~7 minutes, so 10-minute
          # intervals with 5 retries (50 min max wait) should be sufficient.
          MAX_RETRIES=5
          RETRY_INTERVAL=600  # 10 minutes in seconds

          for attempt in $(seq 1 $MAX_RETRIES); do
            echo "=== Attempt $attempt of $MAX_RETRIES ==="

            # Check if lock is currently held
            LOCK_HOLDER=$(hcloud server describe pc1 -o json | jq -r '.labels.lock_holder // empty')
            if [[ -n "$LOCK_HOLDER" ]]; then
              echo "VMs are locked by: $LOCK_HOLDER"
              if [[ $attempt -lt $MAX_RETRIES ]]; then
                echo "Waiting ${RETRY_INTERVAL}s before retry..."
                sleep $RETRY_INTERVAL
                continue
              else
                echo "::error::VMs still locked after $MAX_RETRIES attempts. Giving up."
                exit 1
              fi
            fi

            # Try to run the upgrade script
            if tests/integration/scripts/upgrade-vms.sh; then
              echo "VM upgrade completed successfully"
              exit 0
            fi

            # Check if failure was due to lock acquisition
            # (script may have failed to acquire lock if someone grabbed it between check and acquire)
            LOCK_HOLDER=$(hcloud server describe pc1 -o json | jq -r '.labels.lock_holder // empty')
            if [[ -n "$LOCK_HOLDER" ]]; then
              echo "Lock was acquired by $LOCK_HOLDER during upgrade attempt"
              if [[ $attempt -lt $MAX_RETRIES ]]; then
                echo "Waiting ${RETRY_INTERVAL}s before retry..."
                sleep $RETRY_INTERVAL
                continue
              else
                echo "::error::VMs still locked after $MAX_RETRIES attempts. Giving up."
                exit 1
              fi
            fi

            # Non-lock-related failure
            echo "::error::VM upgrade failed (not due to locking)"
            exit 1
          done

      - name: VMs not available
        if: steps.vm_ips.outputs.vms_exist == 'false'
        run: |
          echo "::warning::Test VMs (pc1, pc2) do not exist. Skipping upgrade."
          echo "VMs are created on-demand when integration tests run."
